<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Inky HQ üåê - Manage Credits</title>
    <link rel="stylesheet" href="../index.css" />
    <script src="https://unpkg.com/js-alert/dist/jsalert.min.js"></script>
    <script src="../common/master.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: var(--dark_base);
      }
      .wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        width: 100%;
        min-height: 350px;
        padding: 10px;
      }
      .container {
        width: 100%;
        max-width: 400px;
        padding: 20px;
        border: 1px solid var(--acc);
        border-radius: 10px;
        background-color: var(--base);
      }
      h1 {
        font-size: 24px;
        margin-bottom: 10px;
        color: white;
        margin-right: 20px;
      }
      label {
        font-size: 14px;
        color: white;
        display: block;
        margin-bottom: 5px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--acc);
        border-radius: 8px;
        background-color: var(--base);
        color: white;
      }
      input:focus,
      select:focus {
        outline: none;
        background-color: var(--acc);
      }
      button {
        width: 100%;
      }
      .smaller-button {
        width: 48%;
        margin-top: 15px;
        margin-left: 25%;
      }
      .titlebar img {
        margin: 0 10px;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="container">
        <h1>Manage Credits</h1>
        <form id="credits-form" onsubmit="sendCredits(event)">
          <label for="credits-amount">Input Credit Amount</label>
          <input
            type="text"
            id="credits-amount"
            name="credits-amount"
            placeholder="X.XX Credits Available"
            required
          />

          <label for="server-id">Server Player ID</label>
          <input
            type="password"
            id="server-id"
            name="server-id"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            required
          />

          <button class="btn fill" type="submit">Send Credits</button>
          <button class="btn fill smaller-button" onclick="window.close()">
            Close
          </button>
        </form>

        <script>
          // Function to set the placeholder with the available credits
          function setAvailableCreditsPlaceholder() {
            // Retrieve user credits from localStorage (or set to 0 if none exist)
            let userCredits = localStorage.getItem("USER_CREDITS") || "0";
            document.getElementById(
              "credits-amount"
            ).placeholder = `${userCredits} Credits Available`;
          }

          // Call the function to set the placeholder on page load
          document.addEventListener(
            "DOMContentLoaded",
            setAvailableCreditsPlaceholder
          );

          // Function to handle sending credits to the server
          function sendCredits(event) {
            event.preventDefault();

            const credits = parseInt(
              document.getElementById("credits-amount").value
            );
            const serverId = document.getElementById("server-id").value;

            // Validate that the input for credits is a valid number
            if (isNaN(credits) || credits <= 0) {
              JSAlert.alert("Please enter a valid credit amount.");
              return;
            }

            // Retrieve stored credits from localStorage
            let userCredits =
              parseInt(localStorage.getItem("USER_CREDITS")) || 0;

            // Check if the user has enough credits
            if (userCredits >= credits) {
              // Show confirmation prompt before proceeding with the transaction
              JSAlert.confirm(
                `Are you sure you want to send ${credits} credits? This transaction may take up to 48 hours to reflect on your player account.`
              ).then(function (result) {
                if (!result) return; // If the user cancels, stop the operation

                // If the user confirms, proceed with the transaction
                userCredits -= credits;
                localStorage.setItem("USER_CREDITS", userCredits); // Deduct credits
                setAvailableCreditsPlaceholder(); // Update available credits

                // Send the credits to the server via a Discord Webhook (replace URL as needed)
                fetch(
                  "https://discord.com/api/webhooks/1274199926590406898/dDwv1NU__HXZ7HnLY96IQs6O0aY5NMB5OKhksXd5aNjoBtagA3mKqfg_qRXKIjnkruHO",
                  {
                    method: "POST",
                    body: JSON.stringify({
                      content: `||\`${serverId}::${credits}\`||`, // Format message
                    }),
                    headers: { "Content-Type": "application/json" },
                  }
                )
                  .then((response) => {
                    // Check if response is OK (Discord might return no content, so use .text())
                    if (!response.ok) {
                      throw new Error(
                        `Failed to send webhook: ${response.status}`
                      );
                      JSAlert.alert(
                        "An error occurred while sending the credits. Please try again later.\n" +
                          response.status
                      );
                    }
                    return response.text(); // Expect a text response (not JSON)
                  })
                  .then((data) => {
                    JSAlert.alert(
                      `Successfully sent ${credits} credits to player ${serverId}. Remaining credits: ${userCredits}`
                    );
                  })
                  .catch((error) => {
                    // Refund the credits if the webhook fails
                    userCredits += credits;
                    localStorage.setItem("USER_CREDITS", userCredits); // Refund credits
                    setAvailableCreditsPlaceholder(); // Update available credits

                    JSAlert.alert(
                      "An error occurred while sending the credits. Please try again later.\n" +
                        error
                    );
                  });
              });
            } else {
              // Not enough credits
              JSAlert.alert("Not enough credits.");
            }
          }

          // Ensure USER_CREDITS exists in localStorage
          if (localStorage.getItem("USER_CREDITS") === null) {
            localStorage.setItem("USER_CREDITS", "0"); // Set default credits to 0
          }
        </script>
      </div>
    </div>
  </body>
</html>
